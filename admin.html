<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة إدارة الموظفين</title>

<!-- خط عربي -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<!-- Bootstrap 5 RTL -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

<style>
body { font-family: 'Cairo', sans-serif; background-color: #eef1f5; }
h2 { color: #007bff; border-right: 4px solid #28a745; padding-right: 10px; margin-bottom: 20px; }
#employee-count { font-weight: bold; margin-right: auto; }
.employee-item { padding: 15px; background: #f9f9f9; border-right: 5px solid #007bff; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.form-control:focus { box-shadow: 0 0 5px rgba(0,123,255,0.3); }
.attendance-controls button { margin-right: 5px; }
section { display: none; } /* إخفاء كل الأقسام أولاً */
</style>
</head>
<body oncontextmenu="return false;">

<div class="container my-4 p-4 bg-white rounded shadow">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h2>إدارة الموظفين 👨‍💼</h2>
        <button id="logout-btn" class="btn btn-danger">تسجيل خروج 🚪</button>
    </div>

    <!-- إضافة موظف -->
    <div class="row g-2 mb-3">
        <div class="col-md-2"><input type="text" id="employee-name" class="form-control" placeholder="اسم الموظف"></div>
        <div class="col-md-2"><input type="email" id="employee-email" class="form-control" placeholder="البريد الإلكتروني"></div>
        <div class="col-md-2"><input type="password" id="employee-password" class="form-control" placeholder="كلمة المرور"></div>
        <div class="col-md-2"><input type="number" id="employee-salary" class="form-control" placeholder="الراتب (دينار)"></div>
        <div class="col-md-2">
            <select id="employee-role" class="form-select">
                <option value="employee">موظف</option>
                <option value="admin">مدير</option>
            </select>
        </div>
        <div class="col-md-2"><button id="add-employee-btn" class="btn btn-success w-100">إضافة ➕</button></div>
    </div>

    <!-- إدارة الموقع -->
    <hr>
    <h2>إدارة إحداثيات الموقع 📍</h2>
    <div class="row g-2 mb-3">
        <div class="col-md-3"><input type="text" id="office-latitude" class="form-control" placeholder="خط العرض"></div>
        <div class="col-md-3"><input type="text" id="office-longitude" class="form-control" placeholder="خط الطول"></div>
        <div class="col-md-3"><input type="number" id="proximity-radius" class="form-control" placeholder="نصف القطر" value="50"></div>
        <div class="col-md-3"><button id="save-location-btn" class="btn btn-success w-100">حفظ الإحداثيات</button></div>
    </div>

    <!-- أزرار عرض الأقسام -->
    <div class="d-flex align-items-center mb-3 flex-wrap">
        <button id="show-employees-btn" class="btn btn-primary me-2 mb-2">عرض الموظفين 📜</button>
        <button id="daily-report-btn" class="btn btn-info me-2 mb-2">تقرير يومي 📅</button>
        <button id="monthly-report-btn" class="btn btn-warning me-2 mb-2">تقرير شهري 📊</button>
        <span id="employee-count" class="mb-2"></span>
    </div>
</div>

<!-- قسم الموظفين -->
<section id="employees-section" class="container my-4 p-4 bg-white rounded shadow"></section>

<!-- التقرير اليومي -->
<section id="daily-report-section" class="container my-4 p-4 bg-white rounded shadow">
    <h2>تقرير يومي 📅</h2>
    <div class="d-flex mb-3 gap-2">
        <input type="date" id="daily-date" class="form-control" style="max-width:200px;">
        <button id="daily-filter-btn" class="btn btn-info">عرض التقرير</button>
    </div>
    <div class="table-responsive">
        <table id="daily-table" class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>اسم الموظف</th>
                    <th>الحضور</th>
                    <th>الانصراف</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>

<!-- التقرير الشهري -->
<section id="monthly-report-section" class="container my-4 p-4 bg-white rounded shadow">
    <h2>تقرير شهري 📊</h2>
    <div class="d-flex mb-3 gap-2">
        <input type="month" id="monthly-date" class="form-control" style="max-width:200px;">
        <button id="monthly-filter-btn" class="btn btn-warning">عرض التقرير</button>
    </div>
    <div class="table-responsive">
        <table id="monthly-table" class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>اسم الموظف</th>
                    <th>عدد ساعات العمل</th>
                    <th>الغياب</th>
                    <th>الراتب (دينار)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>

<!-- Firebase JS -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDLAF7NllObxnciIdRXlKe_BrFJE5sKHHE",
    authDomain: "attendance-system-65084.firebaseapp.com",
    projectId: "attendance-system-65084",
    storageBucket: "attendance-system-65084.firebasestorage.app",
    messagingSenderId: "918305105898",
    appId: "1:918305105898:web:94cf532638acdfbbc27493"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// حماية صفحة الأدمن
auth.onAuthStateChanged(async (user)=>{
    if(!user){ window.location.href="index.html"; return; }
    const doc = await db.collection("users").doc(user.uid).get();
    if(!doc.exists || doc.data().role!=="admin"){ alert("غير مصرح لك بالدخول 🚫"); window.location.href="index.html"; return; }

    // عناصر DOM
    const logoutBtn = document.getElementById('logout-btn');
    const saveLocationBtn = document.getElementById('save-location-btn');
    const officeLatitudeInput = document.getElementById('office-latitude');
    const officeLongitudeInput = document.getElementById('office-longitude');
    const proximityRadiusInput = document.getElementById('proximity-radius');

    const employeesSection = document.getElementById('employees-section');
    const dailySection = document.getElementById('daily-report-section');
    const monthlySection = document.getElementById('monthly-report-section');
    const employeesListDiv = employeesSection;

    function hideAllSections(){ employeesSection.style.display="none"; dailySection.style.display="none"; monthlySection.style.display="none"; }

    // تسجيل خروج
    logoutBtn.addEventListener('click', ()=> auth.signOut().then(()=>window.location.href='index.html'));

    // حفظ الموقع
    saveLocationBtn.addEventListener('click', async()=>{
        const lat=parseFloat(officeLatitudeInput.value);
        const lon=parseFloat(officeLongitudeInput.value);
        const radius=parseInt(proximityRadiusInput.value);
        if(!lat||!lon||!radius){ alert('يرجى تعبئة جميع حقول الموقع.'); return; }
        await db.collection('settings').doc('office_location').set({latitude:lat, longitude:lon, radius:radius});
        alert('تم حفظ إحداثيات الموقع بنجاح ✅');
    });

    // إضافة موظف
    document.getElementById('add-employee-btn').addEventListener('click', async()=>{
        const name = document.getElementById('employee-name').value.trim();
        const email = document.getElementById('employee-email').value.trim();
        const password = document.getElementById('employee-password').value.trim();
        const salary = parseFloat(document.getElementById('employee-salary').value.trim()) || 0;
        const role = document.getElementById('employee-role').value;
        if(!name||!email||!password){ alert('يرجى تعبئة جميع الحقول'); return; }
        try{
            const userCred = await auth.createUserWithEmailAndPassword(email,password);
            await db.collection('users').doc(userCred.user.uid).set({name,email,role,salary,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
            alert('تم إضافة الموظف ✅');
            document.getElementById('employee-name').value='';
            document.getElementById('employee-email').value='';
            document.getElementById('employee-password').value='';
            document.getElementById('employee-salary').value='';
            showEmployees();
        }catch(err){ alert('خطأ: '+err.message); }
    });

    // عرض الموظفين
    document.getElementById('show-employees-btn').addEventListener('click', showEmployees);
    async function showEmployees(){
        hideAllSections();
        employeesSection.style.display='block';
        const snapshot = await db.collection('users').get();
        employeesSection.innerHTML = '';
        document.getElementById('employee-count').textContent=`عدد الموظفين: ${snapshot.size}`;
        snapshot.forEach(doc=>{
            const user = doc.data();
            const div = document.createElement('div');
            div.className='employee-item';
            div.innerHTML = `<span>${user.name} (${user.email}) - الدور: ${user.role} - الراتب: ${user.salary} دينار</span>
            <div>
                <button class="btn btn-warning btn-sm me-1">تعديل</button>
                <button class="btn btn-danger btn-sm">حذف</button>
            </div>`;
            const editBtn = div.querySelector('.btn-warning');
            const delBtn = div.querySelector('.btn-danger');
            editBtn.addEventListener('click', async()=>{
                const newName = prompt('ادخل الاسم الجديد:', user.name);
                if(newName) await db.collection('users').doc(doc.id).update({name:newName});
                const newSalary = parseFloat(prompt('ادخل الراتب الجديد (دينار):', user.salary));
                if(!isNaN(newSalary)) await db.collection('users').doc(doc.id).update({salary:newSalary});
                showEmployees();
            });
            delBtn.addEventListener('click', async()=>{
                if(confirm(`هل تريد حذف الموظف ${user.name}?`)){
                    await db.collection('users').doc(doc.id).delete();
                    showEmployees();
                }
            });
            employeesSection.appendChild(div);
        });
    }

    // التقرير اليومي
    document.getElementById('daily-report-btn').addEventListener('click', ()=>{
        hideAllSections();
        dailySection.style.display='block';
    });

    document.getElementById('daily-filter-btn').addEventListener('click', async ()=>{
        const dateVal = document.getElementById('daily-date').value;
        if(!dateVal) return alert('اختر التاريخ');
        const start = new Date(dateVal); start.setHours(0,0,0,0);
        const end = new Date(dateVal); end.setHours(23,59,59,999);
        const usersSnap = await db.collection('users').get();
        const usersData = {};
        usersSnap.forEach(doc=>usersData[doc.id]=doc.data());
        const attendanceSnap = await db.collection('attendance_log')
            .where('timestamp','>=',start).where('timestamp','<=',end).orderBy('timestamp','desc').get();
        const attendanceByEmployee={};
        attendanceSnap.forEach(doc=>{
            const data = doc.data();
            const uid=data.userId;
            if(!attendanceByEmployee[uid]) attendanceByEmployee[uid]={'حضور':null,'انصراف':null};
            if(data.type==='حضور'&&!attendanceByEmployee[uid]['حضور']) attendanceByEmployee[uid]['حضور']=new Date(data.timestamp.toDate());
            else if(data.type==='انصراف'&&!attendanceByEmployee[uid]['انصراف']) attendanceByEmployee[uid]['انصراف']=new Date(data.timestamp.toDate());
        });
        const tbody = document.querySelector('#daily-table tbody');
        tbody.innerHTML='';
        Object.keys(attendanceByEmployee).forEach(uid=>{
            const userData = usersData[uid]||{name:'غير معروف'};
            const row = document.createElement('tr');
            const checkIn = attendanceByEmployee[uid]['حضور'];
            const checkOut = attendanceByEmployee[uid]['انصراف'];
            row.innerHTML = `<td>${userData.name}</td><td>${checkIn?checkIn.toLocaleTimeString('ar-EG'):'-'}</td><td>${checkOut?checkOut.toLocaleTimeString('ar-EG'):'-'}</td>`;
            tbody.appendChild(row);
        });
        if(tbody.innerHTML==='') tbody.innerHTML='<tr><td colspan="3">لا توجد بيانات حضور لهذا اليوم.</td></tr>';
    });

    // التقرير الشهري
    document.getElementById('monthly-report-btn').addEventListener('click', ()=>{ hideAllSections(); monthlySection.style.display='block'; });
    document.getElementById('monthly-filter-btn').addEventListener('click', async()=>{
        const monthVal = document.getElementById('monthly-date').value; 
        if(!monthVal) return alert('اختر الشهر');
        const [year,month] = monthVal.split('-');
        const start = new Date(year, month-1, 1); start.setHours(0,0,0,0);
        const end = new Date(year, month, 0); end.setHours(23,59,59,999);
        const usersSnap = await db.collection('users').get();
        const usersData = {};
        usersSnap.forEach(doc=>usersData[doc.id]=doc.data());
        const attendanceSnap = await db.collection('attendance_log')
            .where('timestamp','>=',start).where('timestamp','<=',end).orderBy('timestamp','desc').get();
        const attendanceByEmployee={};
        attendanceSnap.forEach(doc=>{
            const data=doc.data();
            const uid=data.userId;
            if(!attendanceByEmployee[uid]) attendanceByEmployee[uid]={totalHours:0,daysPresent:0};
            if(data.type==='حضور') attendanceByEmployee[uid].lastCheckIn = new Date(data.timestamp.toDate());
            else if(data.type==='انصراف' && attendanceByEmployee[uid].lastCheckIn){
                const diff = (new Date(data.timestamp.toDate()) - attendanceByEmployee[uid].lastCheckIn)/1000/60/60;
                attendanceByEmployee[uid].totalHours += diff;
                attendanceByEmployee[uid].daysPresent +=1;
                attendanceByEmployee[uid].lastCheckIn=null;
            }
        });
        const tbody = document.querySelector('#monthly-table tbody'); tbody.innerHTML='';
        Object.keys(usersData).forEach(uid=>{
            const user = usersData[uid];
            const attendance = attendanceByEmployee[uid]||{totalHours:0,daysPresent:0};
            const totalHours = Math.floor(attendance.totalHours);
            const absentDays = (end.getDate() - attendance.daysPresent);
            const dailySalary = user.salary/7; // راتب لكل يوم عمل 7 ساعات
            const salaryEarned = Math.floor(attendance.totalHours*dailySalary/7);
            const row = document.createElement('tr');
            row.innerHTML=`<td>${user.name}</td><td>${totalHours}</td><td>${absentDays}</td><td>${salaryEarned}</td>`;
            tbody.appendChild(row);
        });
    });
});
</script>
</body>
</html>
