<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>

<!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<!-- Bootstrap 5 RTL -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

<style>
body { font-family: 'Cairo', sans-serif; background-color: #eef1f5; }
h2 { color: #007bff; border-right: 4px solid #28a745; padding-right: 10px; margin-bottom: 20px; }
#employee-count { font-weight: bold; margin-right: auto; }
.employee-item { padding: 15px; background: #f9f9f9; border-right: 5px solid #007bff; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.form-control:focus { box-shadow: 0 0 5px rgba(0,123,255,0.3); }
.attendance-controls button { margin-right: 5px; }
section { display: none; } /* Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹ */
</style>
</head>
<body oncontextmenu="return false;">

<div class="container my-4 p-4 bg-white rounded shadow">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ğŸ‘¨â€ğŸ’¼</h2>
        <button id="logout-btn" class="btn btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸšª</button>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù -->
    <div class="row g-2 mb-3">
        <div class="col-md-2"><input type="text" id="employee-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù"></div>
        <div class="col-md-2"><input type="email" id="employee-email" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"></div>
        <div class="col-md-2"><input type="password" id="employee-password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
        <div class="col-md-2"><input type="number" id="employee-salary" class="form-control" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ (Ø¯ÙŠÙ†Ø§Ø±)"></div>
        <div class="col-md-2">
            <select id="employee-role" class="form-select">
                <option value="employee">Ù…ÙˆØ¸Ù</option>
                <option value="admin">Ù…Ø¯ÙŠØ±</option>
            </select>
        </div>
        <div class="col-md-2"><button id="add-employee-btn" class="btn btn-success w-100">Ø¥Ø¶Ø§ÙØ© â•</button></div>
    </div>

    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <hr>
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ğŸ“</h2>
    <div class="row g-2 mb-3">
        <div class="col-md-3"><input type="text" id="office-latitude" class="form-control" placeholder="Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶"></div>
        <div class="col-md-3"><input type="text" id="office-longitude" class="form-control" placeholder="Ø®Ø· Ø§Ù„Ø·ÙˆÙ„"></div>
        <div class="col-md-3"><input type="number" id="proximity-radius" class="form-control" placeholder="Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø±" value="50"></div>
        <div class="col-md-3"><button id="save-location-btn" class="btn btn-success w-100">Ø­ÙØ¸ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button></div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
    <div class="d-flex align-items-center mb-3 flex-wrap">
        <button id="show-employees-btn" class="btn btn-primary me-2 mb-2">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ğŸ“œ</button>
        <button id="daily-report-btn" class="btn btn-info me-2 mb-2">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ ğŸ“…</button>
        <button id="monthly-report-btn" class="btn btn-warning me-2 mb-2">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ ğŸ“Š</button>
        <span id="employee-count" class="mb-2"></span>
    </div>
</div>

<!-- Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
<section id="employees-section" class="container my-4 p-4 bg-white rounded shadow"></section>

<!-- Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
<section id="daily-report-section" class="container my-4 p-4 bg-white rounded shadow">
    <h2>ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ ğŸ“…</h2>
    <div class="d-flex mb-3 gap-2">
        <input type="date" id="daily-date" class="form-control" style="max-width:200px;">
        <button id="daily-filter-btn" class="btn btn-info">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>
    <div class="table-responsive">
        <table id="daily-table" class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th>Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                    <th>Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>

<!-- Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ -->
<section id="monthly-report-section" class="container my-4 p-4 bg-white rounded shadow">
    <h2>ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ ğŸ“Š</h2>
    <div class="d-flex mb-3 gap-2">
        <input type="month" id="monthly-date" class="form-control" style="max-width:200px;">
        <button id="monthly-filter-btn" class="btn btn-warning">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>
    <div class="table-responsive">
        <table id="monthly-table" class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th>Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th>
                    <th>Ø§Ù„ØºÙŠØ§Ø¨</th>
                    <th>Ø§Ù„Ø±Ø§ØªØ¨ (Ø¯ÙŠÙ†Ø§Ø±)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>

<!-- Firebase JS -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDLAF7NllObxnciIdRXlKe_BrFJE5sKHHE",
    authDomain: "attendance-system-65084.firebaseapp.com",
    projectId: "attendance-system-65084",
    storageBucket: "attendance-system-65084.firebasestorage.app",
    messagingSenderId: "918305105898",
    appId: "1:918305105898:web:94cf532638acdfbbc27493"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Ø­Ù…Ø§ÙŠØ© ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
auth.onAuthStateChanged(async (user)=>{
    if(!user){ window.location.href="index.html"; return; }
    const doc = await db.collection("users").doc(user.uid).get();
    if(!doc.exists || doc.data().role!=="admin"){ alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸš«"); window.location.href="index.html"; return; }

    // Ø¹Ù†Ø§ØµØ± DOM
    const logoutBtn = document.getElementById('logout-btn');
    const saveLocationBtn = document.getElementById('save-location-btn');
    const officeLatitudeInput = document.getElementById('office-latitude');
    const officeLongitudeInput = document.getElementById('office-longitude');
    const proximityRadiusInput = document.getElementById('proximity-radius');

    const employeesSection = document.getElementById('employees-section');
    const dailySection = document.getElementById('daily-report-section');
    const monthlySection = document.getElementById('monthly-report-section');
    const employeesListDiv = employeesSection;

    function hideAllSections(){ employeesSection.style.display="none"; dailySection.style.display="none"; monthlySection.style.display="none"; }

    // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    logoutBtn.addEventListener('click', ()=> auth.signOut().then(()=>window.location.href='index.html'));

    // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    saveLocationBtn.addEventListener('click', async()=>{
        const lat=parseFloat(officeLatitudeInput.value);
        const lon=parseFloat(officeLongitudeInput.value);
        const radius=parseInt(proximityRadiusInput.value);
        if(!lat||!lon||!radius){ alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'); return; }
        await db.collection('settings').doc('office_location').set({latitude:lat, longitude:lon, radius:radius});
        alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù
    document.getElementById('add-employee-btn').addEventListener('click', async()=>{
        const name = document.getElementById('employee-name').value.trim();
        const email = document.getElementById('employee-email').value.trim();
        const password = document.getElementById('employee-password').value.trim();
        const salary = parseFloat(document.getElementById('employee-salary').value.trim()) || 0;
        const role = document.getElementById('employee-role').value;
        if(!name||!email||!password){ alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
        try{
            const userCred = await auth.createUserWithEmailAndPassword(email,password);
            await db.collection('users').doc(userCred.user.uid).set({name,email,role,salary,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù âœ…');
            document.getElementById('employee-name').value='';
            document.getElementById('employee-email').value='';
            document.getElementById('employee-password').value='';
            document.getElementById('employee-salary').value='';
            showEmployees();
        }catch(err){ alert('Ø®Ø·Ø£: '+err.message); }
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    document.getElementById('show-employees-btn').addEventListener('click', showEmployees);
    async function showEmployees(){
        hideAllSections();
        employeesSection.style.display='block';
        const snapshot = await db.collection('users').get();
        employeesSection.innerHTML = '';
        document.getElementById('employee-count').textContent=`Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${snapshot.size}`;
        snapshot.forEach(doc=>{
            const user = doc.data();
            const div = document.createElement('div');
            div.className='employee-item';
            div.innerHTML = `<span>${user.name} (${user.email}) - Ø§Ù„Ø¯ÙˆØ±: ${user.role} - Ø§Ù„Ø±Ø§ØªØ¨: ${user.salary} Ø¯ÙŠÙ†Ø§Ø±</span>
            <div>
                <button class="btn btn-warning btn-sm me-1">ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-danger btn-sm">Ø­Ø°Ù</button>
            </div>`;
            const editBtn = div.querySelector('.btn-warning');
            const delBtn = div.querySelector('.btn-danger');
            editBtn.addEventListener('click', async()=>{
                const newName = prompt('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', user.name);
                if(newName) await db.collection('users').doc(doc.id).update({name:newName});
                const newSalary = parseFloat(prompt('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¯ÙŠÙ†Ø§Ø±):', user.salary));
                if(!isNaN(newSalary)) await db.collection('users').doc(doc.id).update({salary:newSalary});
                showEmployees();
            });
            delBtn.addEventListener('click', async()=>{
                if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ${user.name}?`)){
                    await db.collection('users').doc(doc.id).delete();
                    showEmployees();
                }
            });
            employeesSection.appendChild(div);
        });
    }

    // Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ
    document.getElementById('daily-report-btn').addEventListener('click', ()=>{
        hideAllSections();
        dailySection.style.display='block';
    });

    document.getElementById('daily-filter-btn').addEventListener('click', async ()=>{
        const dateVal = document.getElementById('daily-date').value;
        if(!dateVal) return alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®');
        const start = new Date(dateVal); start.setHours(0,0,0,0);
        const end = new Date(dateVal); end.setHours(23,59,59,999);
        const usersSnap = await db.collection('users').get();
        const usersData = {};
        usersSnap.forEach(doc=>usersData[doc.id]=doc.data());
        const attendanceSnap = await db.collection('attendance_log')
            .where('timestamp','>=',start).where('timestamp','<=',end).orderBy('timestamp','desc').get();
        const attendanceByEmployee={};
        attendanceSnap.forEach(doc=>{
            const data = doc.data();
            const uid=data.userId;
            if(!attendanceByEmployee[uid]) attendanceByEmployee[uid]={'Ø­Ø¶ÙˆØ±':null,'Ø§Ù†ØµØ±Ø§Ù':null};
            if(data.type==='Ø­Ø¶ÙˆØ±'&&!attendanceByEmployee[uid]['Ø­Ø¶ÙˆØ±']) attendanceByEmployee[uid]['Ø­Ø¶ÙˆØ±']=new Date(data.timestamp.toDate());
            else if(data.type==='Ø§Ù†ØµØ±Ø§Ù'&&!attendanceByEmployee[uid]['Ø§Ù†ØµØ±Ø§Ù']) attendanceByEmployee[uid]['Ø§Ù†ØµØ±Ø§Ù']=new Date(data.timestamp.toDate());
        });
        const tbody = document.querySelector('#daily-table tbody');
        tbody.innerHTML='';
        Object.keys(attendanceByEmployee).forEach(uid=>{
            const userData = usersData[uid]||{name:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'};
            const row = document.createElement('tr');
            const checkIn = attendanceByEmployee[uid]['Ø­Ø¶ÙˆØ±'];
            const checkOut = attendanceByEmployee[uid]['Ø§Ù†ØµØ±Ø§Ù'];
            row.innerHTML = `<td>${userData.name}</td><td>${checkIn?checkIn.toLocaleTimeString('ar-EG'):'-'}</td><td>${checkOut?checkOut.toLocaleTimeString('ar-EG'):'-'}</td>`;
            tbody.appendChild(row);
        });
        if(tbody.innerHTML==='') tbody.innerHTML='<tr><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</td></tr>';
    });

    // Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ
    document.getElementById('monthly-report-btn').addEventListener('click', ()=>{ hideAllSections(); monthlySection.style.display='block'; });
    document.getElementById('monthly-filter-btn').addEventListener('click', async()=>{
        const monthVal = document.getElementById('monthly-date').value; 
        if(!monthVal) return alert('Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±');
        const [year,month] = monthVal.split('-');
        const start = new Date(year, month-1, 1); start.setHours(0,0,0,0);
        const end = new Date(year, month, 0); end.setHours(23,59,59,999);
        const usersSnap = await db.collection('users').get();
        const usersData = {};
        usersSnap.forEach(doc=>usersData[doc.id]=doc.data());
        const attendanceSnap = await db.collection('attendance_log')
            .where('timestamp','>=',start).where('timestamp','<=',end).orderBy('timestamp','desc').get();
        const attendanceByEmployee={};
        attendanceSnap.forEach(doc=>{
            const data=doc.data();
            const uid=data.userId;
            if(!attendanceByEmployee[uid]) attendanceByEmployee[uid]={totalHours:0,daysPresent:0};
            if(data.type==='Ø­Ø¶ÙˆØ±') attendanceByEmployee[uid].lastCheckIn = new Date(data.timestamp.toDate());
            else if(data.type==='Ø§Ù†ØµØ±Ø§Ù' && attendanceByEmployee[uid].lastCheckIn){
                const diff = (new Date(data.timestamp.toDate()) - attendanceByEmployee[uid].lastCheckIn)/1000/60/60;
                attendanceByEmployee[uid].totalHours += diff;
                attendanceByEmployee[uid].daysPresent +=1;
                attendanceByEmployee[uid].lastCheckIn=null;
            }
        });
        const tbody = document.querySelector('#monthly-table tbody'); tbody.innerHTML='';
        Object.keys(usersData).forEach(uid=>{
            const user = usersData[uid];
            const attendance = attendanceByEmployee[uid]||{totalHours:0,daysPresent:0};
            const totalHours = Math.floor(attendance.totalHours);
            const absentDays = (end.getDate() - attendance.daysPresent);
            const dailySalary = user.salary/7; // Ø±Ø§ØªØ¨ Ù„ÙƒÙ„ ÙŠÙˆÙ… Ø¹Ù…Ù„ 7 Ø³Ø§Ø¹Ø§Øª
            const salaryEarned = Math.floor(attendance.totalHours*dailySalary/7);
            const row = document.createElement('tr');
            row.innerHTML=`<td>${user.name}</td><td>${totalHours}</td><td>${absentDays}</td><td>${salaryEarned}</td>`;
            tbody.appendChild(row);
        });
    });
});
</script>
</body>
</html>
